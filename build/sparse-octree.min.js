/**
 * sparse-octree v4.1.1 build Dec 05 2017
 * https://github.com/vanruesc/sparse-octree
 * Copyright 2017 Raoul van RÃ¼schen, Zlib
 */

!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],n):n(t.SPARSEOCTREE={},t.three)}(this,function(t,n){"use strict";function e(t,n,e,i){var r,o=0;return n<e?(r=n,o=0):(r=e,o=1),i<r&&(o=2),S[t][o]}function i(t,n,r,o,s,a,l,u,c){var h,p,f,d,y=t.children;if(s>=0&&a>=0&&l>=0)if(null===y)c.push(t);else{h=function(t,n,e,i,r,o){var s=0;return t>n&&t>e?(r<t&&(s|=2),o<t&&(s|=1)):n>e?(i<n&&(s|=4),o<n&&(s|=1)):(i<e&&(s|=4),r<e&&(s|=2)),s}(n,r,o,p=.5*(n+s),f=.5*(r+a),d=.5*(o+l));do{switch(h){case 0:i(y[O],n,r,o,p,f,d,u,c),h=e(h,p,f,d);break;case 1:i(y[1^O],n,r,d,p,f,l,u,c),h=e(h,p,f,l);break;case 2:i(y[2^O],n,f,o,p,a,d,u,c),h=e(h,p,a,d);break;case 3:i(y[3^O],n,f,d,p,a,l,u,c),h=e(h,p,a,l);break;case 4:i(y[4^O],p,r,o,s,f,d,u,c),h=e(h,s,f,d);break;case 5:i(y[5^O],p,r,d,s,f,l,u,c),h=e(h,s,f,l);break;case 6:i(y[6^O],p,f,o,s,a,d,u,c),h=e(h,s,a,d);break;case 7:i(y[7^O],p,f,d,s,a,l,u,c),h=8}}while(h<8)}}function r(t){var n,e,i,o=t.children,s=0;if(null!==o)for(n=0,e=o.length;n<e;++n)(i=1+r(o[n]))>s&&(s=i);return s}function o(t,n,e){var i,r,s=t.children;if(C.min=t.min,C.max=t.max,n.intersectsBox(C))if(null!==s)for(i=0,r=s.length;i<r;++i)o(s[i],n,e);else e.push(t)}function s(t,n,e,i){var r,o,a=t.children;if(e===n)i.push(t);else if(null!==a)for(++e,r=0,o=a.length;r<o;++r)s(a[r],n,e,i)}function a(t){var n,e,i=t.children,r=0;if(null!==i)for(n=0,e=i.length;n<e;++n)r+=a(i[n]);else null!==t.points&&(r=t.points.length);return r}function l(t,n,e,i,r){var o,s,a=i.children,u=!1,c=!1;if(i.contains(t,e.bias)){if(null===a){if(null===i.points)i.points=[],i.data=[];else for(o=0,s=i.points.length;!u&&o<s;++o)u=i.points[o].equals(t);u?(i.data[o-1]=n,c=!0):i.points.length<e.maxPoints||r===e.maxDepth?(i.points.push(t.clone()),i.data.push(n),++e.pointCount,c=!0):(i.split(),i.redistribute(e.bias),a=i.children)}if(null!==a)for(++r,o=0,s=a.length;!c&&o<s;++o)c=l(t,n,e,a[o],r)}return c}function u(t,n,e,i){var r,o,s,l,c,h=e.children,p=null;if(e.contains(t,n.bias))if(null!==h)for(r=0,o=h.length;null===p&&r<o;++r)p=u(t,n,h[r],e);else if(null!==e.points)for(s=e.points,l=e.data,r=0,o=s.length;r<o;++r)if(s[r].equals(t)){c=o-1,p=l[r],r<c&&(s[r]=s[c],l[r]=l[c]),s.pop(),l.pop(),--n.pointCount,null!==i&&a(i)<=n.maxPoints&&i.merge();break}return p}function c(t,n,e){var i,r,o,s=e.children,a=null;if(e.contains(t,n.bias))if(null!==s)for(i=0,r=s.length;null===a&&i<r;++i)a=c(t,n,s[i]);else for(i=0,r=(o=e.points).length;null===a&&i<r;++i)t.distanceToSquared(o[i])<=B&&(a=e.data[i]);return a}function h(t,n,e,i,r,o){var s,a,c,p=i.children,f=null;if(i.contains(t,e.bias))if(i.contains(n,e.bias)){if(null!==p)for(++o,s=0,a=p.length;null===f&&s<a;++s)f=h(t,n,e,p[s],i,o);else for(s=0,a=(c=i.points).length;s<a;++s)if(t.distanceToSquared(c[s])<=B){c[s].copy(n),f=i.data[s];break}}else l(n,f=u(t,e,i,r),e,r,o-1);return f}function p(t,n,e,i){var r,o,s,a,l,u,c,h=i.points,f=i.children,d=null,y=n;if(null!==f)for(r=0,o=(l=f.map(function(n){return{octant:n,distance:n.distanceToCenterSquared(t)}}).sort(function(t,n){return t.distance-n.distance})).length;r<o;++r)(u=l[r].octant).contains(t,y)&&null!==(c=p(t,y,e,u))&&(a=c.point.distanceToSquared(t),(!e||a>0)&&a<y&&(y=a,d=c));else if(null!==h)for(r=0,o=h.length;r<o;++r)s=h[r],a=t.distanceToSquared(s),(!e||a>0)&&a<y&&(y=a,d={point:s.clone(),data:i.data[r]});return d}function f(t,n,e,i,r){var o,s,a,l,u,c=i.points,h=i.children,p=n*n;if(null!==h)for(o=0,s=h.length;o<s;++o)(u=h[o]).contains(t,n)&&f(t,n,e,u,r);else if(null!==c)for(o=0,s=c.length;o<s;++o)a=c[o],l=t.distanceToSquared(a),(!e||l>0)&&l<=p&&r.push({point:a.clone(),data:i.data[o]})}var d=new n.Vector3,y=function(t,e){void 0===t&&(t=new n.Vector3),void 0===e&&(e=new n.Vector3),this.min=t,this.max=e,this.children=null};y.prototype.getCenter=function(t){return void 0===t&&(t=new n.Vector3),t.addVectors(this.min,this.max).multiplyScalar(.5)},y.prototype.getDimensions=function(t){return void 0===t&&(t=new n.Vector3),t.subVectors(this.max,this.min)},y.prototype.split=function(){var t,e,i=this.min,r=this.max,o=this.getCenter(d),s=this.children=[null,null,null,null,null,null,null,null];for(t=0;t<8;++t)e=m[t],s[t]=new this.constructor(new n.Vector3(0===e[0]?i.x:o.x,0===e[1]?i.y:o.y,0===e[2]?i.z:o.z),new n.Vector3(0===e[0]?o.x:r.x,0===e[1]?o.y:r.y,0===e[2]?o.z:r.z))};var m=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],v=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],x=new n.Vector3,w=function(t,e){void 0===t&&(t=new n.Vector3),void 0===e&&(e=0),this.min=t,this.size=e,this.children=null},g={max:{configurable:!0}};g.max.get=function(){return this.min.clone().addScalar(this.size)},w.prototype.getCenter=function(t){return void 0===t&&(t=new n.Vector3),t.copy(this.min).addScalar(.5*this.size)},w.prototype.getDimensions=function(t){return void 0===t&&(t=new n.Vector3),t.set(this.size,this.size,this.size)},w.prototype.split=function(){var t,e,i=this.min,r=this.getCenter(x),o=.5*this.size,s=this.children=[null,null,null,null,null,null,null,null];for(t=0;t<8;++t)e=m[t],s[t]=new this.constructor(new n.Vector3(0===e[0]?i.x:r.x,0===e[1]?i.y:r.y,0===e[2]?i.z:r.z),o)},Object.defineProperties(w.prototype,g);var b=function(t,n){void 0===t&&(t=null),void 0===n&&(n=!1),this.value=t,this.done=n};b.prototype.reset=function(){this.value=null,this.done=!1};var A=new n.Box3,z=function(t,n){void 0===n&&(n=null),this.octree=t,this.region=n,this.cull=null!==n,this.result=new b,this.trace=null,this.indices=null,this.reset()};z.prototype.reset=function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(A.min=t.min,A.max=t.max,this.cull&&!this.region.intersectsBox(A)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this},z.prototype.next=function(){for(var t,n,e,i=this.cull,r=this.region,o=this.indices,s=this.trace,a=null,l=s.length-1;null===a&&l>=0;)if(t=o[l],n=s[l].children,++o[l],t<8)if(null!==n){if(e=n[t],i&&(A.min=e.min,A.max=e.max,!r.intersectsBox(A)))continue;s.push(e),o.push(0),++l}else a=s.pop(),o.pop();else s.pop(),o.pop(),--l;return this.result.value=a,this.result.done=null===a,this.result},z.prototype.return=function(t){return this.result.value=t,this.result.done=!0,this.result},z.prototype[Symbol.iterator]=function(){return this};var U=[new n.Vector3,new n.Vector3,new n.Vector3],V=new n.Box3,P=new n.Ray,S=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],O=0,q=function(){};q.intersectOctree=function(t,n,e){var r,o,s,a,l,u,c,h,p,f=V.min.set(0,0,0),d=V.max.subVectors(t.max,t.min),y=t.getDimensions(U[0]),m=U[1].copy(y).multiplyScalar(.5),v=P.origin.copy(n.ray.origin),x=P.direction.copy(n.ray.direction);v.sub(t.getCenter(U[2])).add(m),O=0,x.x<0&&(v.x=y.x-v.x,x.x=-x.x,O|=4),x.y<0&&(v.y=y.y-v.y,x.y=-x.y,O|=2),x.z<0&&(v.z=y.z-v.z,x.z=-x.z,O|=1),r=1/x.x,o=1/x.y,s=1/x.z,a=(f.x-v.x)*r,l=(d.x-v.x)*r,u=(f.y-v.y)*o,c=(d.y-v.y)*o,h=(f.z-v.z)*s,p=(d.z-v.z)*s,Math.max(Math.max(a,u),h)<Math.min(Math.min(l,c),p)&&i(t.root,a,u,h,l,c,p,n,e)};var C=new n.Box3,T=function(t,n){this.root=void 0!==t&&void 0!==n?new y(t,n):null},k={min:{configurable:!0},max:{configurable:!0},children:{configurable:!0}};k.min.get=function(){return this.root.min},k.max.get=function(){return this.root.max},k.children.get=function(){return this.root.children},T.prototype.getCenter=function(t){return this.root.getCenter(t)},T.prototype.getDimensions=function(t){return this.root.getDimensions(t)},T.prototype.getDepth=function(){return r(this.root)},T.prototype.cull=function(t){var n=[];return o(this.root,t,n),n},T.prototype.findOctantsByLevel=function(t){var n=[];return s(this.root,t,0,n),n},T.prototype.raycast=function(t,n){return void 0===n&&(n=[]),q.intersectOctree(this,t,n),n},T.prototype.leaves=function(t){return new z(this,t)},T.prototype[Symbol.iterator]=function(){return new z(this)},Object.defineProperties(T.prototype,k);var M=new n.Vector3,_=function(t){function n(n,e){t.call(this,n,e),this.points=null,this.data=null}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n.prototype.distanceToSquared=function(t){return M.copy(t).clamp(this.min,this.max).sub(t).lengthSq()},n.prototype.distanceToCenterSquared=function(t){var n=this.getCenter(M),e=t.x-n.x,i=t.y-n.x,r=t.z-n.z;return e*e+i*i+r*r},n.prototype.contains=function(t,n){var e=this.min,i=this.max;return t.x>=e.x-n&&t.y>=e.y-n&&t.z>=e.z-n&&t.x<=i.x+n&&t.y<=i.y+n&&t.z<=i.z+n},n.prototype.redistribute=function(t){var n,e,i,r,o,s,a,l=this.children,u=this.points,c=this.data;if(null!==l)for(n=0,i=u.length;n<i;++n)for(s=u[n],a=c[n],e=0,r=l.length;e<r;++e)if((o=l[e]).contains(s,t)){null===o.points&&(o.points=[],o.data=[]),o.points.push(s),o.data.push(a);break}this.points=null,this.data=null},n.prototype.merge=function(){var t,n,e,i=this.children;if(null!==i){for(this.points=[],this.data=[],t=0,n=i.length;t<n;++t)null!==(e=i[t]).points&&((r=this.points).push.apply(r,e.points),(o=this.data).push.apply(o,e.data));this.children=null}var r,o},n}(y),D=function(t,n,e,i){void 0===i&&(i=null),this.distance=t,this.distanceToRay=n,this.point=e,this.object=i},B=1e-6,j=function(t){function n(n,e,i,r,o){void 0===i&&(i=0),void 0===r&&(r=8),void 0===o&&(o=8),t.call(this),this.root=new _(n,e),this.bias=Math.max(0,i),this.maxPoints=Math.max(1,Math.round(r)),this.maxDepth=Math.max(0,Math.round(o)),this.pointCount=0}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n.prototype.countPoints=function(t){return a(t)},n.prototype.put=function(t,n){return l(t,n,this,this.root,0)},n.prototype.remove=function(t){return u(t,this,this.root,null)},n.prototype.fetch=function(t){return c(t,this,this.root)},n.prototype.move=function(t,n){return h(t,n,this,this.root,null,0)},n.prototype.findNearestPoint=function(t,n,e){return void 0===n&&(n=1/0),void 0===e&&(e=!1),p(t,n,e,this.root)},n.prototype.findPoints=function(t,n,e){void 0===e&&(e=!1);var i=[];return f(t,n,e,this.root,i),i},n.prototype.raycast=function(n,e){void 0===e&&(e=[]);var i=t.prototype.raycast.call(this,n);return i.length>0&&this.testPoints(i,n,e),e},n.prototype.testPoints=function(t,n,e){var i,r,o,s,a,l,u,c,h,p,f,d=n.params.Points.threshold,y=d*d;for(a=0,u=t.length;a<u;++a)if(h=t[a],null!==(p=h.points))for(l=0,c=p.length;l<c;++l)f=p[l],(s=n.ray.distanceSqToPoint(f))<y&&(i=n.ray.closestPointToPoint(f),(r=n.ray.origin.distanceTo(i))>=n.near&&r<=n.far&&(o=Math.sqrt(s),e.push(new D(r,o,i,h.data[l]))))},n}(T),R=new n.Box3,E=new n.Vector3,I=new n.Vector3,L=new n.Vector3,N=function(){};N.recycleOctants=function(t,n){var e,i,r,o,s=t.min,a=t.getCenter(I),l=t.getDimensions(L).multiplyScalar(.5),u=t.children,c=n.length;for(e=0;e<8;++e)for(r=m[e],R.min.addVectors(s,E.fromArray(r).multiply(l)),R.max.addVectors(a,E.fromArray(r).multiply(l)),i=0;i<c;++i)if(null!==(o=n[i])&&R.min.equals(o.min)&&R.max.equals(o.max)){u[e]=o,n[i]=null;break}},t.CubicOctant=w,t.edges=v,t.Octant=y,t.Octree=T,t.OctantIterator=z,t.OctreeRaycaster=q,t.pattern=m,t.PointOctant=_,t.PointOctree=j,t.RayPointIntersection=D,t.OctreeUtils=N,Object.defineProperty(t,"__esModule",{value:!0})});