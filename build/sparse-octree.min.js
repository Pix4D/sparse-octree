/**
 * sparse-octree v5.0.1 build Thu Jul 05 2018
 * https://github.com/vanruesc/sparse-octree
 * Copyright 2018 Raoul van RÃ¼schen, Zlib
 */
(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?b(exports,require('three')):'function'==typeof define&&define.amd?define(['exports','three'],b):b(a.SPARSEOCTREE={},a.THREE)})(this,function(a,d){'use strict';function e(a,b,c,d,e,f){var g=0;return a>b&&a>c?(e<a&&(g|=2),f<a&&(g|=1)):b>c?(d<b&&(g|=4),f<b&&(g|=1)):(d<c&&(g|=4),e<c&&(g|=2)),g}function f(a,b,c,d){var e=void 0,f=0;return b<c?(e=b,f=0):(e=c,f=1),d<e&&(f=2),r[a][f]}function g(a,b,c,d,h,i,j,k,l){var m=a.children,n=void 0,o=void 0,p=void 0,q=void 0;if(0<=h&&0<=i&&0<=j)if(null===m)l.push(a);else{o=.5*(b+h),p=.5*(c+i),q=.5*(d+j),n=e(b,c,d,o,p,q);do 0===n?(g(m[L],b,c,d,o,p,q,k,l),n=f(n,o,p,q)):1===n?(g(m[1^L],b,c,q,o,p,j,k,l),n=f(n,o,p,j)):2===n?(g(m[2^L],b,p,d,o,i,q,k,l),n=f(n,o,i,q)):3===n?(g(m[3^L],b,p,q,o,i,j,k,l),n=f(n,o,i,j)):4===n?(g(m[4^L],o,c,d,h,p,q,k,l),n=f(n,h,p,q)):5===n?(g(m[5^L],o,c,q,h,p,j,k,l),n=f(n,h,p,j)):6===n?(g(m[6^L],o,p,d,h,i,q,k,l),n=f(n,h,i,q)):7===n?(g(m[7^L],o,p,q,h,i,j,k,l),n=8):void 0;while(8>n)}}function h(a){var b=a.children,c=0,e=void 0,f=void 0,g=void 0;if(null!==b)for(e=0,f=b.length;e<f;++e)g=1+h(b[e]),g>c&&(c=g);return c}function j(a,b,c){var d=a.children,e=void 0,f=void 0;if(N.min=a.min,N.max=a.max,b.intersectsBox(N))if(null!==d)for(e=0,f=d.length;e<f;++e)j(d[e],b,c);else c.push(a)}function k(a,b,c,d){var e=a.children,f=void 0,g=void 0;if(c===b)d.push(a);else if(null!==e)for(++c,f=0,g=e.length;f<g;++f)k(e[f],b,c,d)}function m(a){var b=a.children,c=0,d=void 0,e=void 0;if(null!==b)for(d=0,e=b.length;d<e;++d)c+=m(b[d]);else null!==a.points&&(c=a.points.length);return c}function n(a,b,c,d,e){var f=d.children,g=!1,h=!1,j=void 0,k=void 0;if(d.contains(a,c.bias)){if(null===f){if(null===d.points)d.points=[],d.data=[];else for(j=0,k=d.points.length;!g&&j<k;++j)g=d.points[j].equals(a);g?(d.data[j-1]=b,h=!0):d.points.length<c.maxPoints||e===c.maxDepth?(d.points.push(a.clone()),d.data.push(b),++c.pointCount,h=!0):(d.split(),d.redistribute(c.bias),f=d.children)}if(null!==f)for(++e,j=0,k=f.length;!h&&j<k;++j)h=n(a,b,c,f[j],e)}return h}function o(a,b,c,d){var e=c.children,f=null,g=void 0,h=void 0,j=void 0,k=void 0,n=void 0;if(c.contains(a,b.bias))if(null!==e)for(g=0,h=e.length;null===f&&g<h;++g)f=o(a,b,e[g],c);else if(null!==c.points)for(j=c.points,k=c.data,(g=0,h=j.length);g<h;++g)if(j[g].equals(a)){n=h-1,f=k[g],g<n&&(j[g]=j[n],k[g]=k[n]),j.pop(),k.pop(),--b.pointCount,null!==d&&m(d)<=b.maxPoints&&d.merge();break}return f}function q(a,b,c){var d=c.children,e=null,f=void 0,g=void 0,h=void 0;if(c.contains(a,b.bias))if(null!==d)for(f=0,g=d.length;null===e&&f<g;++f)e=q(a,b,d[f]);else if(null!==c.points)for(h=c.points,f=0,g=h.length;null===e&&f<g;++f)a.distanceToSquared(h[f])<=R&&(e=c.data[f]);return e}function s(a,b,c,d,e,f){var g=d.children,h=null,j=void 0,k=void 0,m=void 0;if(d.contains(a,c.bias))if(!d.contains(b,c.bias))h=o(a,c,d,e),n(b,h,c,e,f-1);else if(null!==g)for(++f,j=0,k=g.length;null===h&&j<k;++j)h=s(a,b,c,g[j],d,f);else if(null!==d.points)for(m=d.points,j=0,k=m.length;j<k;++j)if(a.distanceToSquared(m[j])<=R){m[j].copy(b),h=d.data[j];break}return h}function t(a,b,c,d){var e=d.points,f=d.children,g=null,h=b,j=void 0,k=void 0,m=void 0,n=void 0,o=void 0,q=void 0,r=void 0;if(null!==f)for(o=f.map(function(b){return{octant:b,distance:b.distanceToCenterSquared(a)}}).sort(function(c,a){return c.distance-a.distance}),j=0,k=o.length;j<k;++j)q=o[j].octant,q.contains(a,h)&&(r=t(a,h,c,q),null!==r&&(n=r.point.distanceToSquared(a),(!c||0<n)&&n<h&&(h=n,g=r)));else if(null!==e)for(j=0,k=e.length;j<k;++j)m=e[j],n=a.distanceToSquared(m),(!c||0<n)&&n<h&&(h=n,g={point:m.clone(),data:d.data[j]});return g}function w(a,b,c,d,e){var f=d.points,g=d.children,h=void 0,j=void 0,k=void 0,m=void 0,n=void 0;if(null!==g)for(h=0,j=g.length;h<j;++h)n=g[h],n.contains(a,b)&&w(a,b,c,n,e);else if(null!==f)for(h=0,j=f.length;h<j;++h)k=f[h],m=a.distanceToSquared(k),(!c||0<m)&&m<=b*b&&e.push({point:k.clone(),data:d.data[h]})}var i=Math.max,l=function(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')},x=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),y=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if('value'in e)return e.value;var g=e.get;return void 0===g?void 0:g.call(d)},z=function(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},A=function(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a},B=function(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)},C=new d.Vector3,c=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new d.Vector3,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new d.Vector3;l(this,a),this.min=b,this.max=c,this.children=null}return x(a,[{key:'getCenter',value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new d.Vector3;return a.addVectors(this.min,this.max).multiplyScalar(.5)}},{key:'getDimensions',value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new d.Vector3;return a.subVectors(this.max,this.min)}},{key:'split',value:function(){var a=this.min,b=this.max,c=this.getCenter(C),e=this.children=[null,null,null,null,null,null,null,null],f=void 0,g=void 0;for(f=0;8>f;++f)g=D[f],e[f]=new this.constructor(new d.Vector3(0===g[0]?a.x:c.x,0===g[1]?a.y:c.y,0===g[2]?a.z:c.z),new d.Vector3(0===g[0]?c.x:b.x,0===g[1]?c.y:b.y,0===g[2]?c.z:b.z))}}]),a}(),D=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],E=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],F=new d.Vector3,G=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new d.Vector3,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;l(this,a),this.min=b,this.size=c,this.children=null}return x(a,[{key:'getCenter',value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new d.Vector3;return a.copy(this.min).addScalar(.5*this.size)}},{key:'getDimensions',value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new d.Vector3;return a.set(this.size,this.size,this.size)}},{key:'split',value:function(){var a=this.min,b=this.getCenter(F),c=.5*this.size,e=this.children=[null,null,null,null,null,null,null,null],f=void 0,g=void 0;for(f=0;8>f;++f)g=D[f],e[f]=new this.constructor(new d.Vector3(0===g[0]?a.x:b.x,0===g[1]?a.y:b.y,0===g[2]?a.z:b.z),c)}},{key:'max',get:function(){return this.min.clone().addScalar(this.size)}}]),a}(),H=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,c=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];l(this,a),this.value=b,this.done=c}return x(a,[{key:'reset',value:function(){this.value=null,this.done=!1}}]),a}(),I=new d.Box3,b=function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;l(this,a),this.octree=b,this.region=c,this.cull=null!==c,this.result=new H,this.trace=null,this.indices=null,this.reset()}return x(a,[{key:'reset',value:function(){var a=this.octree.root;return this.trace=[],this.indices=[],null!==a&&(I.min=a.min,I.max=a.max,(!this.cull||this.region.intersectsBox(I))&&(this.trace.push(a),this.indices.push(0))),this.result.reset(),this}},{key:'next',value:function(){for(var a=this.cull,b=this.region,c=this.indices,d=this.trace,e=null,f=d.length-1,g=void 0,h=void 0,i=void 0;null===e&&0<=f;)if(g=c[f]++,h=d[f].children,!(8>g))d.pop(),c.pop(),--f;else if(null!==h){if(i=h[g],a&&(I.min=i.min,I.max=i.max,!b.intersectsBox(I)))continue;d.push(i),c.push(0),++f}else e=d.pop(),c.pop();return this.result.value=e,this.result.done=null===e,this.result}},{key:'return',value:function(a){return this.result.value=a,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),a}(),J=[new d.Vector3,new d.Vector3,new d.Vector3],v=new d.Box3,K=new d.Ray,r=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],L=0,M=function(){function a(){l(this,a)}return x(a,null,[{key:'intersectOctree',value:function(a,b,c){var d=Math.min,e=v.min.set(0,0,0),f=v.max.subVectors(a.max,a.min),h=a.getDimensions(J[0]),j=J[1].copy(h).multiplyScalar(.5),k=K.origin.copy(b.ray.origin),l=K.direction.copy(b.ray.direction),m=void 0,n=void 0,o=void 0,p=void 0,q=void 0,r=void 0,s=void 0,t=void 0,u=void 0;k.sub(a.getCenter(J[2])).add(j),L=0,0>l.x&&(k.x=h.x-k.x,l.x=-l.x,L|=4),0>l.y&&(k.y=h.y-k.y,l.y=-l.y,L|=2),0>l.z&&(k.z=h.z-k.z,l.z=-l.z,L|=1),m=1/l.x,n=1/l.y,o=1/l.z,p=(e.x-k.x)*m,q=(f.x-k.x)*m,r=(e.y-k.y)*n,s=(f.y-k.y)*n,t=(e.z-k.z)*o,u=(f.z-k.z)*o,i(i(p,r),t)<d(d(q,s),u)&&g(a.root,p,r,t,q,s,u,b,c)}}]),a}(),N=new d.Box3,O=function(){function a(b,d){l(this,a),this.root=void 0!==b&&void 0!==d?new c(b,d):null}return x(a,[{key:'getCenter',value:function(a){return this.root.getCenter(a)}},{key:'getDimensions',value:function(a){return this.root.getDimensions(a)}},{key:'getDepth',value:function(){return h(this.root)}},{key:'cull',value:function(a){var b=[];return j(this.root,a,b),b}},{key:'findOctantsByLevel',value:function(a){var b=[];return k(this.root,a,0,b),b}},{key:'raycast',value:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return M.intersectOctree(this,a,b),b}},{key:'leaves',value:function(a){return new b(this,a)}},{key:Symbol.iterator,value:function(){return new b(this)}},{key:'min',get:function(){return this.root.min}},{key:'max',get:function(){return this.root.max}},{key:'children',get:function(){return this.root.children}}]),a}(),P=new d.Vector3,p=function(a){function b(a,c){l(this,b);var d=A(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a,c));return d.points=null,d.data=null,d}return z(b,a),x(b,[{key:'distanceToSquared',value:function(a){var b=P.copy(a).clamp(this.min,this.max);return b.sub(a).lengthSquared()}},{key:'distanceToCenterSquared',value:function(a){var b=this.getCenter(P),c=a.x-b.x,d=a.y-b.x,e=a.z-b.z;return c*c+d*d+e*e}},{key:'contains',value:function(a,b){var c=this.min,d=this.max;return a.x>=c.x-b&&a.y>=c.y-b&&a.z>=c.z-b&&a.x<=d.x+b&&a.y<=d.y+b&&a.z<=d.z+b}},{key:'redistribute',value:function(a){var b=this.children,c=this.points,d=this.data,e=void 0,f=void 0,g=void 0,h=void 0,k=void 0,l=void 0,m=void 0;if(null!==b&&null!==c)for(e=0,g=c.length;e<g;++e)for(l=c[e],m=d[e],(f=0,h=b.length);f<h;++f)if(k=b[f],k.contains(l,a)){null===k.points&&(k.points=[],k.data=[]),k.points.push(l),k.data.push(m);break}this.points=null,this.data=null}},{key:'merge',value:function(){var a=this.children,b=void 0,c=void 0,d=void 0;if(null!==a){for(this.points=[],this.data=[],(b=0,c=a.length);b<c;++b)if(d=a[b],null!==d.points){var e,f;(e=this.points).push.apply(e,B(d.points)),(f=this.data).push.apply(f,B(d.data))}this.children=null}}}]),b}(c),Q=function a(b,c,d){var e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;l(this,a),this.distance=b,this.distanceToRay=c,this.point=d,this.object=e},R=1e-6,S=function(a){function b(a,c){var d=Math.round,e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,f=3<arguments.length&&void 0!==arguments[3]?arguments[3]:8,g=4<arguments.length&&void 0!==arguments[4]?arguments[4]:8;l(this,b);var h=A(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return h.root=new p(a,c),h.bias=i(0,e),h.maxPoints=i(1,d(f)),h.maxDepth=i(0,d(g)),h.pointCount=0,h}return z(b,a),x(b,[{key:'countPoints',value:function(a){return m(a)}},{key:'put',value:function(a,b){return n(a,b,this,this.root,0)}},{key:'remove',value:function(a){return o(a,this,this.root,null)}},{key:'fetch',value:function(a){return q(a,this,this.root)}},{key:'move',value:function(a,b){return s(a,b,this,this.root,null,0)}},{key:'findNearestPoint',value:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1/0,c=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2];return t(a,b,c,this.root)}},{key:'findPoints',value:function(a,b){var c=!!(2<arguments.length&&void 0!==arguments[2])&&arguments[2],d=[];return w(a,b,c,this.root,d),d}},{key:'raycast',value:function(a){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],d=y(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),'raycast',this).call(this,a);return 0<d.length&&this.testPoints(d,a,c),c}},{key:'testPoints',value:function(a,b,c){var e=b.params.Points.threshold,f=void 0,g=void 0,h=void 0,k=void 0,l=void 0,m=void 0,n=void 0,o=void 0,p=void 0,q=void 0,r=void 0;for(l=0,n=a.length;l<n;++l)if(p=a[l],q=p.points,null!==q)for(m=0,o=q.length;m<o;++m)r=q[m],k=b.ray.distanceSqToPoint(r),k<e*e&&(f=b.ray.closestPointToPoint(r,new d.Vector3),g=b.ray.origin.distanceTo(f),g>=b.near&&g<=b.far&&(h=Math.sqrt(k),c.push(new Q(g,h,f,p.data[m]))))}}]),b}(O),T=new d.Box3,U=new d.Vector3,V=new d.Vector3,u=new d.Vector3,W=function(){function a(){l(this,a)}return x(a,null,[{key:'recycleOctants',value:function(a,b){var c=a.min,d=a.getCenter(V),e=a.getDimensions(u).multiplyScalar(.5),f=a.children,g=b.length,h=void 0,k=void 0,l=void 0,m=void 0;for(h=0;8>h;++h)for(l=D[h],T.min.addVectors(c,U.fromArray(l).multiply(e)),T.max.addVectors(d,U.fromArray(l).multiply(e)),k=0;k<g;++k)if(m=b[k],null!==m&&T.min.equals(m.min)&&T.max.equals(m.max)){f[h]=m,b[k]=null;break}}}]),a}();a.CubicOctant=G,a.edges=E,a.Octant=c,a.Octree=O,a.OctantIterator=b,a.OctreeRaycaster=M,a.pattern=D,a.PointOctant=p,a.PointOctree=S,a.RayPointIntersection=Q,a.OctreeUtils=W,Object.defineProperty(a,'__esModule',{value:!0})});
